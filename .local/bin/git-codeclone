#!/bin/bash

default_proto="git@"
default_domain="github.com"
default_user="rilstrats"

input=$1
[[ -z $input ]] && read -p "Please enter repo: " input
[[ -z $input ]] && echo "Exit: No input supplied" && exit

matches=($(echo $input | grep -oP '(git@|https\:\/\/|[^\/\:]*)'))
if [[ ${#matches[@]} -eq 0 ]]; then
    echo "Error: failed to find any matches"
    exit 1
fi

if [[ ${matches[0]} == "git@" || ${matches[0]} == "https://" ]]; then
    proto=${matches[0]}
    # remove first item from array
    matches=(${matches[@]:1})
else
    proto=$default_proto
fi
[[ $proto == "git@" ]] && domain_sep=":" || domain_sep="/"

repo=$proto

if [[ ${#matches[@]} -eq 0 ]]; then
    echo "Error: failed to find any matches"
    exit 1
elif [[ ${#matches[@]} -le 3 ]]; then
    # quiet stupid bash warnings
    exec 3>&2
    exec 2>/dev/null
    domain=${matches[-3]:-$default_domain}
    user=${matches[-2]:-$default_user}
    name=${matches[-1]}
    # restore bash warnings for rest of script
    exec 2>&3
    exec 3>&-

    local_path=$domain/$user/$name
    repo+=$domain$domain_sep$user/$name
else
    url_sep=$domain_sep
    local_path=""
    for match in ${matches[@]}; do
        local_path+=$match/
        repo+=$match$url_sep
        url_sep="/"
    done
    local_path=${local_path::-1}
    repo=${repo::-1}
fi

# deal with trailing .git
if [[ $local_path == *.git ]]; then
    local_path=${local_path::-4}
fi
if [[ $repo != *.git ]]; then
    repo+=.git
fi

abs_path="$CODEPATH/$local_path"

echo -e "repo:\t$repo"
echo -e "path:\t$abs_path"
read -p "Are the above values correct? [y/N]: " input
proceed=$(echo ${input:0:1} | tr '[:upper:]' '[:lower:]')

[[ $proceed != 'y' ]] && echo "Exit: please clone manually" && exit

git ls-remote $repo &> /dev/null || {
    echo "Exit: repo doesn't exist"
    exit 
}

[[ -d $abs_path ]] && echo "Exit: path already exists" && exit

mkdir -p $abs_path
git clone $repo $abs_path
